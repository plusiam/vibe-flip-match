import { useState, useEffect, useRef } from 'react';
import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
import { Trophy, RotateCcw, Lightbulb, Volume2, VolumeX, BookOpen, Brain, Zap } from 'lucide-react';
import GameCard from './GameCard';
import PlayerNameModal from './PlayerNameModal';
import Leaderboard from './Leaderboard';
import DifficultySelector from './DifficultySelector';
import CategorySelector from './CategorySelector';
import { useToast } from '@/hooks/use-toast';
import { supabase } from '@/integrations/supabase/client';
import { playSound } from '@/lib/sounds';

interface GameCard {
  id: number;
  content: string;
  matchContent: string;
  isFlipped: boolean;
  isMatched: boolean;
}

// ÍµêÏú°Ï†Å ÏΩòÌÖêÏ∏† Ïπ¥ÌÖåÍ≥†Î¶¨
const LEARNING_CATEGORIES = {
  emoji: {
    name: 'Ïù¥Î™®ÏßÄ',
    icon: 'üòä',
    pairs: [
      { front: 'üéÆ', back: 'üéÆ' },
      { front: 'üéØ', back: 'üéØ' },
      { front: 'üé®', back: 'üé®' },
      { front: 'üé≠', back: 'üé≠' },
      { front: 'üé™', back: 'üé™' },
      { front: 'üéµ', back: 'üéµ' },
      { front: 'üé∏', back: 'üé∏' },
      { front: '‚öΩ', back: '‚öΩ' },
      { front: 'üèÄ', back: 'üèÄ' },
      { front: '‚ö°', back: '‚ö°' },
      { front: 'üåü', back: 'üåü' },
      { front: 'üî•', back: 'üî•' }
    ]
  },
  math: {
    name: 'ÏàòÌïô',
    icon: 'üî¢',
    pairs: [
      { front: '2+2', back: '4' },
      { front: '3√ó3', back: '9' },
      { front: '10√∑2', back: '5' },
      { front: '7-3', back: '4' },
      { front: '5√ó5', back: '25' },
      { front: '15√∑3', back: '5' },
      { front: '8+7', back: '15' },
      { front: '6√ó4', back: '24' },
      { front: '20√∑4', back: '5' },
      { front: '9-6', back: '3' },
      { front: '4√ó7', back: '28' },
      { front: '30√∑6', back: '5' }
    ]
  },
  english: {
    name: 'ÏòÅÏñ¥',
    icon: 'üî§',
    pairs: [
      { front: 'cat', back: 'Í≥†ÏñëÏù¥' },
      { front: 'dog', back: 'Í∞ú' },
      { front: 'book', back: 'Ï±Ö' },
      { front: 'apple', back: 'ÏÇ¨Í≥º' },
      { front: 'water', back: 'Î¨º' },
      { front: 'sun', back: 'ÌÉúÏñë' },
      { front: 'moon', back: 'Îã¨' },
      { front: 'star', back: 'Î≥Ñ' },
      { front: 'tree', back: 'ÎÇòÎ¨¥' },
      { front: 'flower', back: 'ÍΩÉ' },
      { front: 'house', back: 'Ïßë' },
      { front: 'car', back: 'ÏûêÎèôÏ∞®' }
    ]
  },
  science: {
    name: 'Í≥ºÌïô',
    icon: 'üî¨',
    pairs: [
      { front: 'H‚ÇÇO', back: 'Î¨º' },
      { front: 'O‚ÇÇ', back: 'ÏÇ∞ÏÜå' },
      { front: 'CO‚ÇÇ', back: 'Ïù¥ÏÇ∞ÌôîÌÉÑÏÜå' },
      { front: 'NaCl', back: 'ÏÜåÍ∏à' },
      { front: 'Fe', back: 'Ï≤†' },
      { front: 'Au', back: 'Í∏à' },
      { front: 'Ag', back: 'ÏùÄ' },
      { front: 'N‚ÇÇ', back: 'ÏßàÏÜå' },
      { front: 'He', back: 'Ìó¨Î•®' },
      { front: 'C', back: 'ÌÉÑÏÜå' },
      { front: 'H‚ÇÇ', back: 'ÏàòÏÜå' },
      { front: 'Ca', back: 'ÏπºÏäò' }
    ]
  },
  history: {
    name: 'Ïó≠ÏÇ¨',
    icon: 'üìö',
    pairs: [
      { front: 'ÏÑ∏Ï¢ÖÎåÄÏôï', back: 'ÌïúÍ∏Ä' },
      { front: 'Ïù¥ÏàúÏã†', back: 'Í±∞Î∂ÅÏÑ†' },
      { front: 'Í¥ëÍ∞úÌÜ†ÎåÄÏôï', back: 'Í≥†Íµ¨Î†§' },
      { front: 'ÍπÄÍµ¨', back: 'ÎèÖÎ¶ΩÏö¥Îèô' },
      { front: 'Ïã†ÏÇ¨ÏûÑÎãπ', back: 'ÌôîÍ∞Ä' },
      { front: 'Ïû•Î≥¥Í≥†', back: 'Ìï¥ÏÉÅÏôï' },
      { front: 'Ï†ïÏïΩÏö©', back: 'Ïã§Ìïô' },
      { front: 'ÏïàÏ∞ΩÌò∏', back: 'ÎèÑÏÇ∞' },
      { front: 'Ïú†Í¥ÄÏàú', back: '3.1Ïö¥Îèô' },
      { front: 'ÍπÄÏú†Ïã†', back: 'Ïã†Îùº' },
      { front: 'ÏùÑÏßÄÎ¨∏Îçï', back: 'ÏÇ¥ÏàòÎåÄÏ≤©' },
      { front: 'ÏôïÍ±¥', back: 'Í≥†Î†§' }
    ]
  }
};

// ÎÇúÏù¥ÎèÑ ÏÑ§Ï†ï
const DIFFICULTY_LEVELS = {
  easy: { 
    name: 'Ïâ¨ÏõÄ', 
    pairs: 4, 
    timeBonus: 180, 
    scoreMultiplier: 1,
    icon: 'üòä'
  },
  medium: { 
    name: 'Î≥¥ÌÜµ', 
    pairs: 6, 
    timeBonus: 120, 
    scoreMultiplier: 1.5,
    icon: 'üòé'
  },
  hard: { 
    name: 'Ïñ¥Î†§ÏõÄ', 
    pairs: 8, 
    timeBonus: 90, 
    scoreMultiplier: 2,
    icon: 'üî•'
  },
  expert: {
    name: 'Ï†ÑÎ¨∏Í∞Ä',
    pairs: 10,
    timeBonus: 60,
    scoreMultiplier: 3,
    icon: 'üíé'
  }
};

const MemoryGame = () => {
  const [cards, setCards] = useState<GameCard[]>([]);
  const [flippedCards, setFlippedCards] = useState<number[]>([]);
  const [moves, setMoves] = useState(0);
  const [score, setScore] = useState(0);
  const [time, setTime] = useState(0);
  const [isGameActive, setIsGameActive] = useState(false);
  const [gameCompleted, setGameCompleted] = useState(false);
  const [playerName, setPlayerName] = useState('');
  const [showNameModal, setShowNameModal] = useState(false);
  const [showLeaderboard, setShowLeaderboard] = useState(false);
  const [leaderboardRefresh, setLeaderboardRefresh] = useState(0);
  const [difficulty, setDifficulty] = useState<keyof typeof DIFFICULTY_LEVELS>('medium');
  const [category, setCategory] = useState<keyof typeof LEARNING_CATEGORIES>('emoji');
  const [soundEnabled, setSoundEnabled] = useState(true);
  const [hintsUsed, setHintsUsed] = useState(0);
  const [wrongAttempts, setWrongAttempts] = useState(0);
  const [streak, setStreak] = useState(0);
  const [showDifficulty, setShowDifficulty] = useState(false);
  const [showCategory, setShowCategory] = useState(false);
  const hintTimeoutRef = useRef<NodeJS.Timeout | null>(null);
  const { toast } = useToast();

  // Ï†êÏàò Í≥ÑÏÇ∞ Ìï®Ïàò (ÎÇúÏù¥ÎèÑÏôÄ Ïó∞ÏÜç ÏÑ±Í≥µ Î≥¥ÎÑàÏä§ Ìè¨Ìï®)
  const calculateScore = (timeElapsed: number, movesCount: number) => {
    const diff = DIFFICULTY_LEVELS[difficulty];
    const baseScore = 1000 * diff.scoreMultiplier;
    const timeBonus = Math.max(0, diff.timeBonus - timeElapsed) * 2;
    const movePenalty = movesCount * 5;
    const streakBonus = streak * 50;
    const hintPenalty = hintsUsed * 100;
    
    return Math.max(100, Math.floor(baseScore + timeBonus - movePenalty + streakBonus - hintPenalty));
  };

  // ÌûåÌä∏ ÏãúÏä§ÌÖú
  const useHint = () => {
    if (hintsUsed >= 3 || gameCompleted || flippedCards.length > 0) {
      toast({
        title: "ÌûåÌä∏ ÏÇ¨Ïö© Î∂àÍ∞Ä",
        description: "Ïù¥ÎØ∏ Ïπ¥ÎìúÎ•º Îí§ÏßëÍ≥† ÏûàÍ±∞ÎÇò ÌûåÌä∏Î•º Î™®Îëê ÏÇ¨Ïö©ÌñàÏäµÎãàÎã§.",
        variant: "destructive"
      });
      return;
    }

    const unmatchedCards = cards.filter(card => !card.isMatched);
    if (unmatchedCards.length === 0) return;

    // ÎûúÎç§ÏúºÎ°ú Îß§Ïπ≠ Ïåç ÌïòÎÇò ÏÑ†ÌÉù
    const cardPairs = new Map<string, number[]>();
    unmatchedCards.forEach(card => {
      const key = card.matchContent;
      if (!cardPairs.has(key)) {
        cardPairs.set(key, []);
      }
      cardPairs.get(key)!.push(card.id);
    });

    const pairsArray = Array.from(cardPairs.values()).filter(pair => pair.length === 2);
    if (pairsArray.length === 0) return;

    const randomPair = pairsArray[Math.floor(Math.random() * pairsArray.length)];
    
    // ÌûåÌä∏Î°ú Ïπ¥Îìú Ïû†Íπê Î≥¥Ïó¨Ï£ºÍ∏∞
    setCards(prevCards => 
      prevCards.map(card => 
        randomPair.includes(card.id) 
          ? { ...card, isFlipped: true } 
          : card
      )
    );

    if (soundEnabled) playSound('hint');
    
    hintTimeoutRef.current = setTimeout(() => {
      setCards(prevCards => 
        prevCards.map(card => 
          randomPair.includes(card.id) && !card.isMatched
            ? { ...card, isFlipped: false } 
            : card
        )
      );
    }, 1500);

    setHintsUsed(prev => prev + 1);
    toast({
      title: "üí° ÌûåÌä∏ ÏÇ¨Ïö©!",
      description: `ÎÇ®ÏùÄ ÌûåÌä∏: ${3 - hintsUsed - 1}Í∞ú`,
    });
  };

  // Í≤åÏûÑ Ï¥àÍ∏∞Ìôî
  const initializeGame = () => {
    if (hintTimeoutRef.current) {
      clearTimeout(hintTimeoutRef.current);
    }

    const selectedCategory = LEARNING_CATEGORIES[category];
    const numPairs = DIFFICULTY_LEVELS[difficulty].pairs;
    
    // Ïπ¥ÌÖåÍ≥†Î¶¨ÏóêÏÑú ÌïÑÏöîÌïú ÏàòÎßåÌÅº Ïåç ÏÑ†ÌÉù
    const selectedPairs = selectedCategory.pairs
      .sort(() => Math.random() - 0.5)
      .slice(0, numPairs);
    
    // Ïπ¥Îìú Î∞∞Ïó¥ ÏÉùÏÑ±
    const gameCards: GameCard[] = [];
    let id = 0;
    
    selectedPairs.forEach(pair => {
      // Ï≤´ Î≤àÏß∏ Ïπ¥Îìú
      gameCards.push({
        id: id++,
        content: pair.front,
        matchContent: pair.front + pair.back,
        isFlipped: false,
        isMatched: false,
      });
      // Îëê Î≤àÏß∏ Ïπ¥Îìú
      gameCards.push({
        id: id++,
        content: pair.back,
        matchContent: pair.front + pair.back,
        isFlipped: false,
        isMatched: false,
      });
    });
    
    // Ïπ¥Îìú ÏÑûÍ∏∞
    const shuffledCards = gameCards.sort(() => Math.random() - 0.5);
    
    setCards(shuffledCards);
    setFlippedCards([]);
    setMoves(0);
    setScore(0);
    setTime(0);
    setIsGameActive(true);
    setGameCompleted(false);
    setHintsUsed(0);
    setWrongAttempts(0);
    setStreak(0);
    
    if (soundEnabled) playSound('start');
  };

  // ÏÉà Í≤åÏûÑ ÏãúÏûë
  const startNewGame = () => {
    setShowNameModal(true);
  };

  const handlePlayerNameSubmit = (name: string) => {
    setPlayerName(name);
    setShowNameModal(false);
    setShowCategory(true);
  };

  // Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù ÌõÑ ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù
  const handleCategorySelect = (cat: keyof typeof LEARNING_CATEGORIES) => {
    setCategory(cat);
    setShowCategory(false);
    setShowDifficulty(true);
  };

  // ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù ÌõÑ Í≤åÏûÑ ÏãúÏûë
  const handleDifficultySelect = (diff: keyof typeof DIFFICULTY_LEVELS) => {
    setDifficulty(diff);
    setShowDifficulty(false);
    initializeGame();
  };

  // ÌÉÄÏù¥Î®∏ Ìö®Í≥º
  useEffect(() => {
    let interval: NodeJS.Timeout;
    if (isGameActive && !gameCompleted) {
      interval = setInterval(() => {
        setTime(time => time + 1);
      }, 1000);
    }
    return () => clearInterval(interval);
  }, [isGameActive, gameCompleted]);

  // Ïπ¥Îìú ÌÅ¥Î¶≠ Ï≤òÎ¶¨
  const handleCardClick = (id: number) => {
    if (flippedCards.length === 2) return;
    if (flippedCards.includes(id)) return;

    const clickedCard = cards.find(card => card.id === id);
    if (!clickedCard || clickedCard.isMatched) return;

    const newFlippedCards = [...flippedCards, id];
    setFlippedCards(newFlippedCards);
    
    setCards(cards => 
      cards.map(card => 
        card.id === id ? { ...card, isFlipped: true } : card
      )
    );

    if (soundEnabled) playSound('flip');

    if (newFlippedCards.length === 2) {
      setMoves(moves => moves + 1);
      
      setTimeout(() => {
        checkForMatch(newFlippedCards);
      }, 1000);
    }
  };

  // Îß§Ïπ≠ ÌôïÏù∏
  const checkForMatch = (flippedCardIds: number[]) => {
    const [first, second] = flippedCardIds;
    const firstCard = cards.find(card => card.id === first);
    const secondCard = cards.find(card => card.id === second);

    if (firstCard?.matchContent === secondCard?.matchContent) {
      // Îß§Ïπ≠ ÏÑ±Í≥µ
      setCards(cards => 
        cards.map(card => 
          flippedCardIds.includes(card.id) 
            ? { ...card, isMatched: true } 
            : card
        )
      );
      
      setStreak(prev => prev + 1);
      setWrongAttempts(0);
      
      // Ï†êÏàò Ï∂îÍ∞Ä
      const matchScore = calculateScore(time, moves);
      const pairScore = Math.floor(matchScore / DIFFICULTY_LEVELS[difficulty].pairs);
      setScore(prevScore => prevScore + pairScore);
      
      if (soundEnabled) playSound('match');
      
      toast({
        title: `Îß§Ïπ≠ ÏÑ±Í≥µ! ${streak > 1 ? `üî• ${streak}Ïó∞ÏÜç!` : 'üéâ'}`,
        description: `+${pairScore}Ï†ê ÌöçÎìù!`,
      });
    } else {
      // Îß§Ïπ≠ Ïã§Ìå®
      setCards(cards => 
        cards.map(card => 
          flippedCardIds.includes(card.id) 
            ? { ...card, isFlipped: false } 
            : card
        )
      );
      
      setStreak(0);
      setWrongAttempts(prev => prev + 1);
      
      if (soundEnabled) playSound('wrong');
      
      // 3Î≤à Ïù¥ÏÉÅ ÌãÄÎ¶¨Î©¥ ÌûåÌä∏ Ï†úÏïà
      if (wrongAttempts >= 2 && hintsUsed < 3) {
        toast({
          title: "üí° ÌûåÌä∏Î•º ÏÇ¨Ïö©Ìï¥Î≥¥ÏÑ∏Ïöî!",
          description: "ÏÉÅÎã®Ïùò ÌûåÌä∏ Î≤ÑÌäºÏùÑ ÎàåÎü¨ ÎèÑÏõÄÏùÑ Î∞õÏùÑ Ïàò ÏûàÏäµÎãàÎã§.",
        });
      }
    }
    
    setFlippedCards([]);
  };

  // Í≤åÏûÑ ÏôÑÎ£å ÌôïÏù∏
  useEffect(() => {
    if (cards.length > 0 && cards.every(card => card.isMatched)) {
      setIsGameActive(false);
      setGameCompleted(true);
      
      // ÏµúÏ¢Ö Ï†êÏàò Í≥ÑÏÇ∞
      const finalScore = score + calculateScore(time, moves);
      setScore(finalScore);
      
      if (soundEnabled) playSound('complete');
      
      // Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Ïóê Ï†ÄÏû•
      saveGameRecord(finalScore);
    }
  }, [cards, score, time, moves]);

  // Í≤åÏûÑ Í∏∞Î°ù Ï†ÄÏû•
  const saveGameRecord = async (finalScore: number) => {
    try {
      const { error } = await supabase
        .from('game_records')
        .insert({
          player_name: playerName,
          score: finalScore,
          time_seconds: time,
          moves: moves,
          difficulty,
          category,
        });

      if (error) throw error;

      setLeaderboardRefresh(prev => prev + 1);
      
      const difficultyName = DIFFICULTY_LEVELS[difficulty].name;
      const categoryName = LEARNING_CATEGORIES[category].name;
      
      toast({
        title: "Í≤åÏûÑ ÏôÑÎ£å! üéä",
        description: `${difficultyName} ÎÇúÏù¥ÎèÑ, ${categoryName} Ïπ¥ÌÖåÍ≥†Î¶¨ÏóêÏÑú ${finalScore.toLocaleString()}Ï†ê ÌöçÎìù!`,
      });
    } catch (error) {
      console.error('Í≤åÏûÑ Í∏∞Î°ù Ï†ÄÏû• Ï§ë Ïò§Î•ò:', error);
    }
  };

  // Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏Ïãú Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄ ÌôïÏù∏
  useEffect(() => {
    const savedName = localStorage.getItem('memory-game-player-name');
    const savedSound = localStorage.getItem('memory-game-sound');
    
    setSoundEnabled(savedSound !== 'false');
    
    if (!savedName) {
      setShowNameModal(true);
    } else {
      setPlayerName(savedName);
      setShowNameModal(true);
    }
  }, []);

  const formatTime = (seconds: number) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  };

  const toggleSound = () => {
    const newValue = !soundEnabled;
    setSoundEnabled(newValue);
    localStorage.setItem('memory-game-sound', String(newValue));
    if (newValue) playSound('flip');
  };

  return (
    <div className="flex flex-col items-center gap-6 p-6">
      <div className="text-center">
        <h1 className="text-4xl font-bold mb-2 bg-gradient-to-r from-primary to-accent bg-clip-text text-transparent">
          Î©îÎ™®Î¶¨ Ïπ¥Îìú Í≤åÏûÑ
        </h1>
        <p className="text-muted-foreground">
          {category !== 'emoji' && (
            <span className="font-semibold">
              {LEARNING_CATEGORIES[category].icon} {LEARNING_CATEGORIES[category].name} ÌïôÏäµ Î™®Îìú
            </span>
          )}
        </p>
        {playerName && (
          <p className="text-sm text-primary font-semibold mt-1">
            ÌîåÎ†àÏù¥Ïñ¥: {playerName} | ÎÇúÏù¥ÎèÑ: {DIFFICULTY_LEVELS[difficulty].icon} {DIFFICULTY_LEVELS[difficulty].name}
          </p>
        )}
      </div>

      {/* Í≤åÏûÑ ÌÜµÍ≥Ñ */}
      <Card className="game-header px-6 py-4 rounded-xl">
        <div className="flex items-center gap-4">
          <div className="text-center">
            <div className="text-2xl font-bold text-primary">{formatTime(time)}</div>
            <div className="text-sm text-muted-foreground">ÏãúÍ∞Ñ</div>
          </div>
          <div className="text-center">
            <div className="text-2xl font-bold text-accent">{moves}</div>
            <div className="text-sm text-muted-foreground">ÏãúÎèÑ</div>
          </div>
          <div className="text-center">
            <div className="text-2xl font-bold text-success">{score.toLocaleString()}</div>
            <div className="text-sm text-muted-foreground">Ï†êÏàò</div>
          </div>
          {streak > 0 && (
            <div className="text-center">
              <div className="text-2xl font-bold text-orange-500 flex items-center">
                <Zap className="w-5 h-5 mr-1" />
                {streak}
              </div>
              <div className="text-sm text-muted-foreground">Ïó∞ÏÜç</div>
            </div>
          )}
          <div className="flex gap-2 ml-4">
            <Button
              onClick={useHint}
              disabled={hintsUsed >= 3 || gameCompleted || !isGameActive}
              variant="outline"
              size="sm"
              className="hover:bg-yellow-500/20 transition-colors"
            >
              <Lightbulb className="w-4 h-4 mr-1" />
              ÌûåÌä∏ ({3 - hintsUsed})
            </Button>
            <Button
              onClick={toggleSound}
              variant="outline"
              size="icon"
              className="hover:bg-primary hover:text-primary-foreground transition-colors"
            >
              {soundEnabled ? <Volume2 className="w-4 h-4" /> : <VolumeX className="w-4 h-4" />}
            </Button>
            <Button 
              onClick={startNewGame}
              variant="outline"
              size="sm"
              className="hover:bg-primary hover:text-primary-foreground transition-colors"
            >
              <RotateCcw className="w-4 h-4 mr-1" />
              ÏÉà Í≤åÏûÑ
            </Button>
            <Button 
              onClick={() => setShowLeaderboard(true)}
              variant="outline"
              size="sm"
              className="hover:bg-accent hover:text-accent-foreground transition-colors"
            >
              <Trophy className="w-4 h-4 mr-1" />
              Î¶¨ÎçîÎ≥¥Îìú
            </Button>
          </div>
        </div>
      </Card>

      {/* Í≤åÏûÑ Î≥¥Îìú */}
      {cards.length > 0 && (
        <div 
          className={`grid gap-4 p-6 bg-muted/20 rounded-2xl backdrop-blur-sm game-board`}
          style={{
            gridTemplateColumns: `repeat(${Math.ceil(Math.sqrt(cards.length))}, 1fr)`
          }}
        >
          {cards.map(card => (
            <GameCard
              key={card.id}
              id={card.id}
              content={card.content}
              isFlipped={card.isFlipped}
              isMatched={card.isMatched}
              onClick={handleCardClick}
              disabled={flippedCards.length === 2 || !isGameActive}
              category={category}
            />
          ))}
        </div>
      )}

      {/* Í≤åÏûÑ ÏãúÏûë ÏïàÎÇ¥ */}
      {cards.length === 0 && !showNameModal && !showCategory && !showDifficulty && (
        <Card className="p-8 text-center">
          <h2 className="text-2xl font-bold mb-4">ÌïôÏäµÌïòÎ©∞ Ï¶êÍ∏∞Îäî Î©îÎ™®Î¶¨ Í≤åÏûÑ!</h2>
          <div className="flex gap-4 mb-4 justify-center">
            <div className="text-center">
              <BookOpen className="w-12 h-12 mx-auto mb-2 text-primary" />
              <p className="text-sm">Îã§ÏñëÌïú ÌïôÏäµ Ï£ºÏ†ú</p>
            </div>
            <div className="text-center">
              <Brain className="w-12 h-12 mx-auto mb-2 text-accent" />
              <p className="text-sm">ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù</p>
            </div>
            <div className="text-center">
              <Trophy className="w-12 h-12 mx-auto mb-2 text-success" />
              <p className="text-sm">Î¶¨ÎçîÎ≥¥Îìú Í≤ΩÏüÅ</p>
            </div>
          </div>
          <Button 
            onClick={startNewGame}
            className="bg-gradient-to-r from-primary to-accent hover:opacity-90"
            size="lg"
          >
            Í≤åÏûÑ ÏãúÏûë
          </Button>
        </Card>
      )}

      {/* Í≤åÏûÑ ÏôÑÎ£å Î©îÏãúÏßÄ */}
      {gameCompleted && (
        <Card className="p-6 text-center bounce-in bg-gradient-to-r from-success/10 to-primary/10">
          <div className="text-6xl mb-4">üéâ</div>
          <h2 className="text-2xl font-bold mb-2">Ï∂ïÌïòÌï©ÎãàÎã§!</h2>
          <p className="text-muted-foreground mb-2">
            {DIFFICULTY_LEVELS[difficulty].name} ÎÇúÏù¥ÎèÑ, {LEARNING_CATEGORIES[category].name} Ïπ¥ÌÖåÍ≥†Î¶¨
          </p>
          <p className="text-muted-foreground mb-2">
            {moves}Î≤àÏùò ÏãúÎèÑÎ°ú {formatTime(time)}ÎßåÏóê Í≤åÏûÑÏùÑ ÏôÑÎ£åÌñàÏäµÎãàÎã§!
          </p>
          <p className="text-xl font-bold text-primary mb-4">
            ÏµúÏ¢Ö Ï†êÏàò: {score.toLocaleString()}Ï†ê
          </p>
          <div className="flex gap-2 justify-center">
            <Button 
              onClick={startNewGame}
              className="bg-gradient-to-r from-primary to-accent hover:opacity-90"
            >
              Îã§Ïãú ÎèÑÏ†Ñ
            </Button>
            <Button 
              onClick={() => setShowLeaderboard(true)}
              variant="outline"
              className="hover:bg-accent hover:text-accent-foreground"
            >
              <Trophy className="w-4 h-4 mr-1" />
              Î¶¨ÎçîÎ≥¥Îìú Î≥¥Í∏∞
            </Button>
          </div>
        </Card>
      )}

      {/* Î™®Îã¨Îì§ */}
      <PlayerNameModal 
        isOpen={showNameModal}
        onClose={handlePlayerNameSubmit}
      />
      
      <CategorySelector
        isOpen={showCategory}
        onSelect={handleCategorySelect}
        categories={LEARNING_CATEGORIES}
      />
      
      <DifficultySelector
        isOpen={showDifficulty}
        onSelect={handleDifficultySelect}
        difficulties={DIFFICULTY_LEVELS}
      />
      
      <Leaderboard 
        isOpen={showLeaderboard}
        onClose={() => setShowLeaderboard(false)}
        refreshTrigger={leaderboardRefresh}
      />
    </div>
  );
};

export default MemoryGame;